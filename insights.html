<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ECHELON '26 | INSIGHT CENTER</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --gold: #D4AF37; --maroon: #4B0036; --bg: #0f0f0f; --card: #1a1a1a; --text: #f5f1e6; }
    body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding-bottom: 50px; }

    header { background: var(--maroon); padding: 20px 30px; border-bottom: 3px solid var(--gold); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
    h1 { font-family: 'Cinzel'; color: var(--gold); margin: 0; font-size: 1.5rem; letter-spacing: 2px; }

    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
    
    /* Stats Grid */
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 40px; }
    .insight-card { background: var(--card); border-radius: 15px; border: 1px solid #333; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .card-title { font-family: 'Cinzel'; color: var(--gold); font-size: 0.9rem; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px; display: flex; justify-content: space-between; }

    .chart-container { position: relative; height: 300px; width: 100%; }

    /* Leaderboard Style */
    .leaderboard-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 0.85rem; }
    .rank-circle { width: 24px; height: 24px; background: var(--gold); color: var(--maroon); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; font-size: 0.7rem; }

    .btn-gold { background: var(--gold); color: var(--maroon); border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-family: 'Cinzel'; text-decoration: none; font-size: 0.8rem; }
    
    #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .loader { width: 50px; height: 50px; border: 5px solid #222; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="loader"></div>
    <p style="margin-top: 20px; font-family: 'Cinzel'; color: var(--gold);">Analyzing Data Hub...</p>
  </div>

  <header>
    <h1>INSIGHT CENTER</h1>
    <a href="admin.html" class="btn-gold">COMMAND CENTER</a>
  </header>

  <div class="container">
    <div class="insights-grid">
      
      <div class="insight-card">
        <div class="card-title">Registration Mix <span>By Event</span></div>
        <div class="chart-container">
          <canvas id="eventPieChart"></canvas>
        </div>
      </div>

      <div class="insight-card">
        <div class="card-title">Growth Velocity <span>Daily Trend</span></div>
        <div class="chart-container">
          <canvas id="velocityLineChart"></canvas>
        </div>
      </div>

      <div class="insight-card" style="grid-row: span 2;">
        <div class="card-title">Top Institutions <span>By Volume</span></div>
        <div id="institutionLeaderboard">
          <p style="text-align:center; color:#555; margin-top:50px;">Processing college data...</p>
        </div>
      </div>

      <div class="insight-card">
        <div class="card-title">Process Efficiency <span>Approval Status</span></div>
        <div class="chart-container">
          <canvas id="statusDoughnutChart"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjAI96cSTzwgUtYddm7lTO7dgyDzPm9_T9OQPqQpkafxQe-3rz3NqCE45kFRvuUxja/exec";
    const SECRET_KEY = "ECHELON_SUPER_SECRET_2026";

    window.onload = loadInsightData;

    async function loadInsightData() {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=getAdminData&key=${SECRET_KEY}`);
        const data = await response.json();
        const rows = data.rows;
        
        processInsights(rows);
        document.getElementById('loading-overlay').style.display = 'none';
      } catch (e) { console.error("Insight Load Error:", e); }
    }

    function processInsights(rows) {
      const eventCounts = {};
      const dateCounts = {};
      const statusCounts = { "APPROVED": 0, "PENDING": 0, "REJECTED": 0 };
      const collegeCounts = {};

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        
        // 1. Event Data
        const event = r[3];
        eventCounts[event] = (eventCounts[event] || 0) + 1;

        // 2. Growth Velocity (Daily)
        const rawDate = r[0].split(' ')[0]; // Extract DD/MM/YYYY
        dateCounts[rawDate] = (dateCounts[rawDate] || 0) + 1;

        // 3. Status Data
        const status = r[13] || "PENDING";
        statusCounts[status]++;

        // 4. College Leaderboard
        const college = r[5];
        collegeCounts[college] = (collegeCounts[college] || 0) + 1;
      }

      renderPie(eventCounts);
      renderVelocity(dateCounts);
      renderStatus(statusCounts);
      renderLeaderboard(collegeCounts);
    }

    function renderPie(counts) {
      new Chart(document.getElementById('eventPieChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            data: Object.values(counts),
            backgroundColor: ['#D4AF37', '#4B0036', '#630048', '#00A878', '#2D0021', '#F5F1E6'],
            borderWidth: 0
          }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#f5f1e6', font: { size: 10 } } } } }
      });
    }

    function renderVelocity(counts) {
      // Sort dates
      const labels = Object.keys(counts).sort();
      new Chart(document.getElementById('velocityLineChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'New Registrations',
            data: labels.map(l => counts[l]),
            borderColor: '#D4AF37',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(212, 175, 55, 0.1)'
          }]
        },
        options: { 
          maintainAspectRatio: false, 
          scales: { 
            y: { grid: { color: '#222' }, ticks: { color: '#888' } },
            x: { grid: { display: false }, ticks: { color: '#888' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function renderStatus(counts) {
      new Chart(document.getElementById('statusDoughnutChart'), {
        type: 'doughnut',
        data: {
          labels: ['Approved', 'Pending', 'Rejected'],
          datasets: [{
            data: [counts.APPROVED, counts.PENDING, counts.REJECTED],
            backgroundColor: ['#1b5e20', '#f57f17', '#b71c1c'],
            hoverOffset: 10,
            borderWidth: 0
          }]
        },
        options: { cutout: '70%', maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#888' } } } }
      });
    }

    function renderLeaderboard(counts) {
      const container = document.getElementById('institutionLeaderboard');
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 8);
      
      container.innerHTML = sorted.map((item, idx) => `
        <div class="leaderboard-item">
          <span><span class="rank-circle">${idx+1}</span> ${item[0]}</span>
          <span style="color:var(--gold); font-weight:bold;">${item[1]}</span>
        </div>
      `).join('');
    }
  </script>
</body>
</html>